name: ğŸ” Docker Hub - Production Release

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œç»ä¸è‡ªåŠ¨è¿è¡Œ
    inputs:
      version:
        description: 'Override version'
        required: false
        default: ''

permissions:
  contents: read
  packages: write

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: jonysun/wx2save

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é¡»è·å–å®Œæ•´å†å²æ‰èƒ½è¯»å– tags

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}  # Docker Hub Access Token

      - name: Extract version (auto-detect from Git tag)
        id: get_version
        run: |
          MANUAL_VERSION="${{ github.event.inputs.version }}"
          
          if [ -n "$MANUAL_VERSION" ]; then
            # ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
            VERSION="${MANUAL_VERSION#v}"
            echo "Using manual version: $VERSION"
          else
            # è‡ªåŠ¨æ£€æµ‹æœ€è¿‘çš„ Git æ ‡ç­¾ï¼ˆå¦‚ v1.2.3ï¼‰
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            
            if [ -z "$LATEST_TAG" ]; then
              echo "âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° Git æ ‡ç­¾ï¼Œä¸”æœªæä¾›æ‰‹åŠ¨ç‰ˆæœ¬"
              echo "ğŸ’¡ è¯·å…ˆåˆ›å»ºæ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šgit tag v1.0.0 && git push origin v1.0.0ï¼‰"
              echo "   æˆ–åœ¨è§¦å‘ workflow æ—¶å¡«å†™ 'version' å‚æ•°"
              exit 1
            fi
            
            VERSION="${LATEST_TAG#v}"  # å»æ‰ v å‰ç¼€ â†’ 1.2.3
            
            # å®‰å…¨æ ¡éªŒï¼šé˜²æ­¢è¯¯ç”¨åˆ†æ”¯å
            if [[ "$VERSION" == "main" || "$VERSION" == "master" || "$VERSION" == "dev" ]]; then
              echo "âŒ é”™è¯¯ï¼šæ£€æµ‹åˆ°çš„æ ‡ç­¾ '$LATEST_TAG' ä¸æ˜¯æœ‰æ•ˆç‰ˆæœ¬å·"
              exit 1
            fi
            
            echo "Auto-detected Git tag: $LATEST_TAG â†’ Version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest

      - name: Notify success via Telegram (optional)
        if: success()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… Docker é•œåƒæ¨é€æˆåŠŸ
            ä»“åº“: ${{ env.IMAGE_NAME }}
            ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
            Commit: ${{ github.sha }}
            è§¦å‘è€…: ${{ github.actor }}
      
